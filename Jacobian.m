%% Jacobian Inverse Kinematics
close all;
clear all;
clc;

%Link lengthes
L0 = 0.28135;
L1 = 0.125;
L2 = 0.36435;
L3 = 0.069;
L4 = 0.37429;
L5 = 0.01;
L6 = 0.229525;

%Theta value
t1=0;
t2=-45+90;
t3=0;
t4=90;
t5=0;
t6=-60;
t7=0;

%Initializing the required transformations
T_01 = [cosd(t1) -sind(t1) 0 0; sind(t1) cosd(t1) 0 0; 0 0 1 L0 ; 0 0 0 1];
T_12 = [cosd(t2) -sind(t2) 0 L1; 0 0 1 0; -sind(t2) -cosd(t2) 0 0; 0 0 0 1];
T_23 = [cosd(t3) -sind(t3) 0 0; 0 0 -1 -L2; sind(t3) cosd(t3) 0 0; 0 0 0 1];
T_34 = [cosd(t4) -sind(t4) 0 L3; 0 0 1 0; -sind(t4) -cosd(t4) 0 0; 0 0 0 1];
T_45 = [cosd(t5) -sind(t5) 0 0; 0 0 -1 -L4; sind(t5) cosd(t5) 0 0; 0 0 0 1];
T_56 = [cosd(t6) -sind(t6) 0 L5; 0 0 1 0; -sind(t6) -cosd(t6) 0 0; 0 0 0 1];
T_67 = [cosd(t7) -sind(t7) 0 0; 0 0 -1 -L6; sind(t7) cosd(t7) 0 0; 0 0 0 1];

%Transformation Matricies
T_T = T_01*T_12*T_23*T_34*T_45*T_56*T_67;
T_02 = T_01*T_12;
T_03 = T_02*T_23;
T_04 = T_03*T_34;
T_05 = T_04*T_45;
T_06 = T_05*T_56;
T_07 = T_06*T_67;

T_1_7 = T_12*T_23*T_34*T_45*T_56*T_67;
T_2_7 = T_23*T_34*T_45*T_56*T_67;
T_3_7 = T_34*T_45*T_56*T_67;
T_4_7 = T_45*T_56*T_67;
T_5_7 = T_56*T_67;
T_6_7 = T_67;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

format long

T = [0.70710678 0.70710678 0 0.026;
    -0.70710678 0.70710678 0 0.219;
    0 0 1 0.108;
    0 0 0 1];

%Transformations from joint to base
T_B_0 = inv(T);
T_B_1 = T_01*T_B_0;
T_B_2 = T_B_1*T_12;
T_B_3 = T_B_2*T_23;
T_B_4 = T_B_3*T_34;
T_B_5 = T_B_4*T_45;
T_B_6 = T_B_5*T_56;
T_B_7 = T_B_6*T_67;

%J1
R_B_1 = [T_B_1(1,1) , T_B_1(1,2) , T_B_1(1,3);
         T_B_1(2,1) , T_B_1(2,2) , T_B_1(2,3);
         T_B_1(3,1) , T_B_1(3,2) , T_B_1(3,3)];

P_1_7org = [T_1_7(1,4); T_1_7(2,4); T_1_7(3,4)];

R_1_7 = [T_1_7(1,1) , T_1_7(1,2) , T_1_7(1,3);
         T_1_7(2,1) , T_1_7(2,2) , T_1_7(2,3);
         T_1_7(3,1) , T_1_7(3,2) , T_1_7(3,3)];

P_E_E7 = [0; 0; 0.1];

P_E_1 = R_B_1*P_1_7org + R_B_1*R_1_7*P_E_E7;
Z_hat_1 = [T_B_1(1,3) ; T_B_1(2,3) ; T_B_1(3,3)];
J1 = cross(Z_hat_1,P_E_1);

%J2
R_B_2 = [T_B_2(1,1) , T_B_2(1,2) , T_B_2(1,3);
         T_B_2(2,1) , T_B_2(2,2) , T_B_2(2,3);
         T_B_2(3,1) , T_B_2(3,2) , T_B_2(3,3)];

P_2_7org = [T_2_7(1,4); T_2_7(2,4); T_2_7(3,4)];

R_2_7 = [T_2_7(1,1) , T_2_7(1,2) , T_2_7(1,3);
         T_2_7(2,1) , T_2_7(2,2) , T_2_7(2,3);
         T_2_7(3,1) , T_2_7(3,2) , T_2_7(3,3)];

P_E_E7 = [0; 0; 0.1];

P_E_2 = R_B_2*P_2_7org + R_B_2*R_2_7*P_E_E7;
Z_hat_2 = [T_B_2(1,3) ; T_B_2(2,3) ; T_B_2(3,3)];
J2 = cross(Z_hat_2,P_E_2);

%J3
R_B_3 = [T_B_3(1,1) , T_B_3(1,2) , T_B_3(1,3);
         T_B_3(2,1) , T_B_3(2,2) , T_B_3(2,3);
         T_B_3(3,1) , T_B_3(3,2) , T_B_3(3,3)];

P_3_7org = [T_3_7(1,4); T_3_7(2,4); T_3_7(3,4)];

R_3_7 = [T_3_7(1,1) , T_3_7(1,2) , T_3_7(1,3);
         T_3_7(2,1) , T_3_7(2,2) , T_3_7(2,3);
         T_3_7(3,1) , T_3_7(3,2) , T_3_7(3,3)];

P_E_E7 = [0; 0; 0.1];

P_E_3 = R_B_3*P_3_7org + R_B_3*R_3_7*P_E_E7;
Z_hat_3 = [T_B_3(1,3) ; T_B_3(2,3) ; T_B_3(3,3)];
J3 = cross(Z_hat_3,P_E_3);

%J4
R_B_4 = [T_B_4(1,1) , T_B_4(1,2) , T_B_4(1,3);
         T_B_4(2,1) , T_B_4(2,2) , T_B_4(2,3);
         T_B_4(3,1) , T_B_4(3,2) , T_B_4(3,3)];

P_4_7org = [T_4_7(1,4); T_4_7(2,4); T_4_7(3,4)];

R_4_7 = [T_4_7(1,1) , T_4_7(1,2) , T_4_7(1,3);
         T_4_7(2,1) , T_4_7(2,2) , T_4_7(2,3);
         T_4_7(3,1) , T_4_7(3,2) , T_4_7(3,3)];

P_E_E7 = [0; 0; 0.1];

P_E_4 = R_B_4*P_4_7org + R_B_4*R_4_7*P_E_E7;
Z_hat_4 = [T_B_4(1,3) ; T_B_4(2,3) ; T_B_4(3,3)];
J4 = cross(Z_hat_4,P_E_4);

%J5
R_B_5 = [T_B_5(1,1) , T_B_5(1,2) , T_B_5(1,3);
         T_B_5(2,1) , T_B_5(2,2) , T_B_5(2,3);
         T_B_5(3,1) , T_B_5(3,2) , T_B_5(3,3)];

P_5_7org = [T_5_7(1,4); T_5_7(2,4); T_5_7(3,4)];

R_5_7 = [T_5_7(1,1) , T_5_7(1,2) , T_5_7(1,3);
         T_5_7(2,1) , T_5_7(2,2) , T_5_7(2,3);
         T_5_7(3,1) , T_5_7(3,2) , T_5_7(3,3)];

P_E_E7 = [0; 0; 0.1];

P_E_5 = R_B_5*P_5_7org + R_B_5*R_5_7*P_E_E7;
Z_hat_5 = [T_B_5(1,3) ; T_B_5(2,3) ; T_B_5(3,3)];
J5 = cross(Z_hat_5,P_E_5);

%J6
R_B_6 = [T_B_6(1,1) , T_B_6(1,2) , T_B_6(1,3);
         T_B_6(2,1) , T_B_6(2,2) , T_B_6(2,3);
         T_B_6(3,1) , T_B_6(3,2) , T_B_6(3,3)];

P_6_7org = [T_6_7(1,4); T_6_7(2,4); T_6_7(3,4)];

R_6_7 = [T_6_7(1,1) , T_6_7(1,2) , T_6_7(1,3);
         T_6_7(2,1) , T_6_7(2,2) , T_6_7(2,3);
         T_6_7(3,1) , T_6_7(3,2) , T_6_7(3,3)];

P_E_E7 = [0; 0; 0.1];

P_E_6 = R_B_6*P_6_7org + R_B_6*R_6_7*P_E_E7;
Z_hat_6 = [T_B_6(1,3) ; T_B_6(2,3) ; T_B_6(3,3)];
J6 = cross(Z_hat_6,P_E_6);

%J7
R_B_7 = [T_B_7(1,1) , T_B_7(1,2) , T_B_7(1,3);
         T_B_7(2,1) , T_B_7(2,2) , T_B_7(2,3);
         T_B_7(3,1) , T_B_7(3,2) , T_B_7(3,3)];

P_7_7org = [0; 0; 0.1];

R_7_7 = [1, 0, 0;
         0, 1, 0;
         0, 0, 1];

P_E_E7 = [0; 0; 0.1];

P_E_7 = R_B_7*P_7_7org + R_B_7*R_7_7*P_E_E7;
Z_hat_7 = [T_B_7(1,3) ; T_B_7(2,3) ; T_B_7(3,3)];
J7 = cross(Z_hat_7,P_E_7);

%Jacobian Matrix

J = [J1 J2 J3 J4 J5 J6 J7;
     Z_hat_1 Z_hat_2 Z_hat_3 Z_hat_4 Z_hat_5 Z_hat_6 Z_hat_7];
 
%Integration 
X = pinv(J);
EE_Vs = [0.01;0;0;0;0;0];
JointVs = X*EE_Vs;
JointVs_T = transpose(JointVs);
JointVs_T_deg = radtodeg(JointVs_T);
Joint_angles_new = [0,-45,0,90,0,-60,0]+JointVs_T_deg*0.01;

